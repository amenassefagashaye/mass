<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="·ä†·à∞·çã ·ã≤·åÇ·â≥·àç ·â¢·äï·åé ·å®·ãã·â≥ - Assefa Digital Bingo Game">
    <meta name="keywords" content="Bingo, Ethiopian Bingo, ·â¢·äï·åé, ·ä¢·âµ·ãÆ·åµ·ã´, Game, Online, Multiplayer">
    <meta name="author" content="Assefa Digital Bingo">
    <meta property="og:title" content="·ä†·à∞·çã ·ã≤·åÇ·â≥·àç ·â¢·äï·åé">
    <meta property="og:description" content="Real-time multiplayer Bingo game with Ethiopian style">
    <meta property="og:image" content="https://ameng-gogs-mass2-81.deno.dev/logo.png">
    <meta property="og:url" content="https://ameng-gogs-mass2-81.deno.dev">
    
    <title>·ä†·à∞·çã ·ã≤·åÇ·â≥·àç ·â¢·äï·åé | Assefa Digital Bingo</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéÆ</text></svg>">
    
    <!-- Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Ethiopic:wght@400;500;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Styles -->
    <style>
        /* ===== GLOBAL STYLES ===== */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        /* Add these admin-specific styles */
        #adminSection {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            background: #1a1a1a;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .admin-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #FF6B35;
        }

        .admin-header h2 {
            color: #FF6B35;
            font-family: 'Noto Sans Ethiopic', sans-serif;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #2a2a2a;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            color: #FF6B35;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .stat-card .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #4ECDC4;
        }

        .admin-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .control-group {
            background: #2a2a2a;
            border-radius: 15px;
            padding: 20px;
        }

        .control-group h3 {
            color: #FF6B35;
            margin-bottom: 15px;
            font-family: 'Noto Sans Ethiopic', sans-serif;
        }

        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .admin-btn {
            flex: 1;
            min-width: 120px;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, #FF6B35, #FF8E53);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Noto Sans Ethiopic', sans-serif;
        }

        .admin-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.4);
        }

        .admin-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .admin-btn.danger {
            background: linear-gradient(135deg, #FF416C, #FF4B2B);
        }

        .admin-btn.success {
            background: linear-gradient(135deg, #4ECDC4, #44A08D);
        }

        .players-list {
            background: #2a2a2a;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            max-height: 300px;
            overflow-y: auto;
        }

        .players-list h3 {
            color: #FF6B35;
            margin-bottom: 15px;
            font-family: 'Noto Sans Ethiopic', sans-serif;
        }

        .player-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            margin-bottom: 10px;
            background: #3a3a3a;
            border-radius: 10px;
            transition: background 0.3s;
        }

        .player-item:hover {
            background: #444;
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .player-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FF6B35, #FF8E53);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .player-name {
            color: white;
            font-family: 'Noto Sans Ethiopic', sans-serif;
        }

        .player-status {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .status-online {
            background: #4ECDC4;
            color: white;
        }

        .status-offline {
            background: #666;
            color: white;
        }

        .admin-messages {
            background: #2a2a2a;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .message-log {
            height: 200px;
            overflow-y: auto;
            background: #1a1a1a;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .message-item {
            color: white;
            margin-bottom: 5px;
            padding: 5px 10px;
            border-radius: 5px;
            background: #3a3a3a;
        }

        .message-item.system {
            color: #4ECDC4;
        }

        .message-item.error {
            color: #FF416C;
        }

        .message-input {
            display: flex;
            gap: 10px;
        }

        .message-input input {
            flex: 1;
            padding: 10px 15px;
            border: none;
            border-radius: 10px;
            background: #3a3a3a;
            color: white;
            font-family: 'Noto Sans Ethiopic', sans-serif;
        }

        .message-input input::placeholder {
            color: #888;
        }

        .message-input button {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, #FF6B35, #FF8E53);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .message-input button:hover {
            transform: scale(1.05);
        }

        .admin-footer {
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid #444;
        }

        #adminPasswordModal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .password-modal {
            background: #1a1a1a;
            border-radius: 20px;
            padding: 40px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .password-modal h3 {
            color: #FF6B35;
            margin-bottom: 20px;
            font-family: 'Noto Sans Ethiopic', sans-serif;
            font-size: 1.5rem;
        }

        .password-input {
            margin-bottom: 20px;
        }

        .password-input input {
            width: 100%;
            padding: 15px;
            border: 2px solid #444;
            border-radius: 10px;
            background: #2a2a2a;
            color: white;
            font-size: 1rem;
            text-align: center;
            font-family: 'Noto Sans Ethiopic', sans-serif;
        }

        .password-input input:focus {
            outline: none;
            border-color: #FF6B35;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
        }

        .modal-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Noto Sans Ethiopic', sans-serif;
        }

        .modal-buttons .submit-btn {
            background: linear-gradient(135deg, #FF6B35, #FF8E53);
            color: white;
        }

        .modal-buttons .cancel-btn {
            background: #444;
            color: white;
        }

        .modal-buttons button:hover {
            transform: scale(1.05);
        }

        /* Connection status indicator */
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-family: 'Noto Sans Ethiopic', sans-serif;
            display: none;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .status-connecting {
            background: #FFA726;
            color: white;
        }

        .status-connected {
            background: #4CAF50;
            color: white;
        }

        .status-error {
            background: #F44336;
            color: white;
        }

        .status-disconnected {
            background: #757575;
            color: white;
        }

        /* Loading overlay for admin section */
        .admin-loading {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(26, 26, 26, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            border-radius: 20px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #444;
            border-top: 5px solid #FF6B35;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #FF6B35;
            font-family: 'Noto Sans Ethiopic', sans-serif;
            font-size: 1.2rem;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .admin-container {
                padding: 20px;
                margin: 10px;
            }
            
            .admin-stats {
                grid-template-columns: 1fr;
            }
            
            .admin-controls {
                grid-template-columns: 1fr;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .admin-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Connection Status Indicator -->
    <div id="connectionStatus" class="connection-status"></div>

    <!-- Admin Password Modal -->
    <div id="adminPasswordModal">
        <div class="password-modal">
            <h3>üîê ·ã®·ä†·àµ·â∞·ã≥·ã≥·à™ ·ã®·ã≠·àà·çç ·âÉ·àç</h3>
            <div class="password-input">
                <input type="password" id="adminPassword" placeholder="·ã®·ã≠·àà·çç ·âÉ·àç ·ä†·àµ·åà·â£" autocomplete="off">
            </div>
            <div class="modal-buttons">
                <button class="cancel-btn" onclick="hideAdminModal()">·ãù·åã</button>
                <button class="submit-btn" onclick="checkAdminPassword()">·åç·â£</button>
            </div>
            <p id="passwordError" style="color: #FF416C; margin-top: 10px; display: none;">·ã®·ã≠·àà·çç ·âÉ·àç ·âµ·ä≠·ä≠·àç ·ä†·ã≠·ã∞·àà·àù!</p>
        </div>
    </div>

    <!-- Admin Section (Hidden by default) -->
    <div id="adminSection">
        <div class="admin-container">
            <div id="adminLoading" class="admin-loading">
                <div class="loading-spinner"></div>
                <div class="loading-text">·ã®·ä†·àµ·â∞·ã≥·ã≥·à™ ·çì·äê·àç ·ä•·ã®·â∞·å†·äì·âÄ·âÄ ·äê·ãç...</div>
            </div>
            
            <div class="admin-header">
                <h2>üéÆ ·ã®·ä†·à∞·çã ·â¢·äï·åé ·ä†·àµ·â∞·ã≥·ã∞·à≠ ·çì·äê·àç</h2>
                <p style="color: #888; font-family: 'Noto Sans Ethiopic', sans-serif;">·ã®·å®·ãã·â≥·ãç·äï ·ä•·ãç·âÖ·äì ·ã≠·âÜ·å£·å†·à©</p>
            </div>
            
            <div class="admin-stats">
                <div class="stat-card">
                    <h3>üë• ·ä†·å†·âÉ·àã·ã≠ ·â∞·å´·ãã·âæ·âΩ</h3>
                    <div class="stat-value" id="totalPlayers">0</div>
                </div>
                <div class="stat-card">
                    <h3>üéØ ·ä†·àÅ·äï ·ã´·àâ ·â∞·å´·ãã·âæ·âΩ</h3>
                    <div class="stat-value" id="activePlayers">0</div>
                </div>
                <div class="stat-card">
                    <h3>üèÜ ·ã®·â∞·å†·äì·âÄ·âÅ ·å®·ãã·â≥·ãé·âΩ</h3>
                    <div class="stat-value" id="completedGames">0</div>
                </div>
                <div class="stat-card">
                    <h3>‚è±Ô∏è ·ã®·ä†·àÅ·äë ·å®·ãã·â≥</h3>
                    <div class="stat-value" id="currentGameTime">00:00</div>
                </div>
            </div>
            
            <div class="admin-controls">
                <div class="control-group">
                    <h3>üéÆ ·ã®·å®·ãã·â≥ ·âÅ·å•·å•·à≠</h3>
                    <div class="btn-group">
                        <button class="admin-btn" onclick="startGame()" id="startGameBtn">·å®·ãã·â≥ ·åÄ·àù·à≠</button>
                        <button class="admin-btn" onclick="pauseGame()" id="pauseGameBtn">·å®·ãã·â≥ ·ä†·âÅ·àù</button>
                        <button class="admin-btn danger" onclick="endGame()" id="endGameBtn">·å®·ãã·â≥ ·ä†·âÅ·àù</button>
                    </div>
                    <div class="btn-group">
                        <button class="admin-btn success" onclick="resetGame()" id="resetGameBtn">·å®·ãã·â≥ ·ä•·äï·ã∞·åà·äì ·åÄ·àù·à≠</button>
                        <button class="admin-btn" onclick="callNextNumber()" id="callNumberBtn">·âÅ·å•·à≠ ·å•·à´</button>
                    </div>
                </div>
                
                <div class="control-group">
                    <h3>‚öôÔ∏è ·ã®·å®·ãã·â≥ ·âÖ·äï·â•·àÆ·âΩ</h3>
                    <div class="btn-group">
                        <button class="admin-btn" onclick="changeGameSpeed('slow')">·ãù·åç·â≥</button>
                        <button class="admin-btn success" onclick="changeGameSpeed('normal')">·àò·ã∞·â†·äõ</button>
                        <button class="admin-btn" onclick="changeGameSpeed('fast')">·çà·å£·äï</button>
                    </div>
                    <div class="btn-group">
                        <button class="admin-btn" onclick="toggleSound()" id="soundToggleBtn">·ãµ·àù·åΩ ·ä†·â•·à´</button>
                        <button class="admin-btn" onclick="sendAnnouncement()">·àõ·àµ·â≥·ãà·âÇ·ã´ ·àã·ä≠</button>
                    </div>
                </div>
            </div>
            
            <div class="players-list">
                <h3>üéÆ ·â∞·å´·ãã·âæ·âΩ ·ãù·à≠·ãù·à≠</h3>
                <div id="playersContainer">
                    <!-- Player items will be added here dynamically -->
                </div>
            </div>
            
            <div class="admin-messages">
                <h3>üì® ·ã®·å®·ãã·â≥ ·àò·àç·ãï·ä≠·â∂·âΩ</h3>
                <div class="message-log" id="messageLog">
                    <!-- Messages will be added here -->
                </div>
                <div class="message-input">
                    <input type="text" id="adminMessage" placeholder="·àò·àç·ãï·ä≠·âµ ·ã≠·åª·çâ..." onkeypress="handleAdminMessageKey(event)">
                    <button onclick="sendAdminMessage()">·àã·ä≠</button>
                </div>
            </div>
            
            <div class="admin-footer">
                <button class="admin-btn danger" onclick="closeAdminPanel()" style="margin-right: 10px;">·ä†·àµ·â∞·ã≥·ã∞·à≠ ·ãù·åã</button>
                <button class="admin-btn" onclick="exportGameData()">·ã®·å®·ãã·â≥ ·àò·à®·åÉ ·àã·ä≠</button>
            </div>
        </div>
    </div>

    <!-- Main Game UI (Your existing game content would be here) -->
    <div id="mainGameUI">
        <!-- Your existing game content -->
        <button onclick="showAdminModal()" style="position: fixed; bottom: 20px; right: 20px; z-index: 999; padding: 10px 20px; background: #FF6B35; color: white; border: none; border-radius: 10px; cursor: pointer; font-family: 'Noto Sans Ethiopic', sans-serif;">
            <i class="fas fa-cog"></i> ·ä†·àµ·â∞·ã≥·ã∞·à≠
        </button>
    </div>

    <script>
        // Global variables
        let adminSocket = null;
        let isAdminAuthenticated = false;
        let connectionAttempts = 0;
        const MAX_RETRIES = 3;
        let reconnectTimeout = null;
        const ADMIN_PASSWORD = "assefa2024"; // Default admin password

        // Show admin password modal
        function showAdminModal() {
            document.getElementById('adminPasswordModal').style.display = 'flex';
            document.getElementById('adminPassword').focus();
        }

        // Hide admin password modal
        function hideAdminModal() {
            document.getElementById('adminPasswordModal').style.display = 'none';
            document.getElementById('passwordError').style.display = 'none';
            document.getElementById('adminPassword').value = '';
        }

        // Check admin password
        function checkAdminPassword() {
            const password = document.getElementById('adminPassword').value;
            const errorElement = document.getElementById('passwordError');
            
            if (password === ADMIN_PASSWORD) {
                errorElement.style.display = 'none';
                hideAdminModal();
                initializeAdminPanel();
            } else {
                errorElement.style.display = 'block';
                document.getElementById('adminPassword').value = '';
                document.getElementById('adminPassword').focus();
            }
        }

        // Initialize admin panel
        function initializeAdminPanel() {
            showConnectionStatus('connecting', '·ä®·â∞·àò·àã·àã·çä ·ä†·åà·àç·åã·ã≠ ·åã·à≠ ·â†·àò·åà·äì·äò·âµ ·àã·ã≠...');
            
            // Wake up the backend first with HTTP request
            wakeBackend()
                .then(() => {
                    // Connect WebSocket after backend is awake
                    connectAdminWebSocket();
                })
                .catch(error => {
                    console.error('Failed to wake backend:', error);
                    showConnectionStatus('error', '·â∞·àò·àã·àã·çä ·ä†·åà·àç·åã·ã≠ ·ä†·àç·â∞·åà·äò·àù. ·ä•·äï·ã∞·åà·äì ·ã≠·àû·ä≠·à©...');
                    setTimeout(connectAdminWebSocket, 2000); // Try connecting anyway
                });
        }

        // Wake up the backend server
        async function wakeBackend() {
            try {
                const response = await fetch('https://ameng-gogs-mass2-81.deno.dev/', {
                    method: 'HEAD',
                    cache: 'no-cache',
                    headers: {
                        'X-Wake-Up': 'true'
                    }
                });
                console.log('Backend wake-up response:', response.status);
                return true;
            } catch (error) {
                console.warn('Backend wake-up failed, proceeding with WebSocket anyway');
                return false;
            }
        }

        // Connect to WebSocket server
        function connectAdminWebSocket() {
            if (reconnectTimeout) {
                clearTimeout(reconnectTimeout);
                reconnectTimeout = null;
            }

            connectionAttempts++;
            
            try {
                // Create WebSocket connection with timeout
                const wsUrl = 'wss://ameng-gogs-mass2-81.deno.dev/';
                adminSocket = new WebSocket(wsUrl);
                
                // Set connection timeout
                const connectionTimeout = setTimeout(() => {
                    if (adminSocket && adminSocket.readyState !== WebSocket.OPEN) {
                        adminSocket.close();
                        handleConnectionError('·ã®·åç·äï·äô·äê·âµ ·åä·ãú ·ä†·àç·çè·àç');
                    }
                }, 10000); // 10 second timeout

                adminSocket.onopen = function(event) {
                    clearTimeout(connectionTimeout);
                    connectionAttempts = 0;
                    showConnectionStatus('connected', '·â∞·åà·äì·äù·â∑·àç!');
                    
                    // Send admin authentication
                    authenticateAdmin();
                };

                adminSocket.onmessage = function(event) {
                    try {
                        const message = JSON.parse(event.data);
                        handleAdminMessage(message);
                    } catch (error) {
                        console.error('Error parsing message:', error);
                    }
                };

                adminSocket.onerror = function(error) {
                    clearTimeout(connectionTimeout);
                    handleConnectionError('·ã®·åç·äï·äô·äê·âµ ·àµ·àÖ·â∞·âµ');
                };

                adminSocket.onclose = function(event) {
                    clearTimeout(connectionTimeout);
                    handleConnectionClose(event);
                };

            } catch (error) {
                handleConnectionError('·ã®·åç·äï·äô·äê·âµ ·àµ·àÖ·â∞·âµ: ' + error.message);
            }
        }

        // Authenticate admin
        function authenticateAdmin() {
            if (adminSocket && adminSocket.readyState === WebSocket.OPEN) {
                const authMessage = {
                    type: 'admin_auth',
                    password: ADMIN_PASSWORD,
                    timestamp: Date.now()
                };
                adminSocket.send(JSON.stringify(authMessage));
                
                // Set authentication timeout
                setTimeout(() => {
                    if (!isAdminAuthenticated) {
                        showConnectionStatus('error', '·àõ·à®·åã·åà·å´ ·ä†·àç·â∞·à≥·ä´·àù');
                    }
                }, 5000);
            }
        }

        // Handle incoming messages
        function handleAdminMessage(message) {
            switch (message.type) {
                case 'auth_response':
                    if (message.authenticated) {
                        isAdminAuthenticated = true;
                        showAdminPanel();
                        addSystemMessage('·â†·âµ·ä≠·ä≠·àç ·â∞·à∞·àà·çç·ä≠! ·ã®·ä†·àµ·â∞·ã≥·ã≥·à™ ·çì·äê·àç ·â†·âÖ·å•·â•·å• ·äê·ãç.');
                    } else {
                        addSystemMessage('·àõ·à®·åã·åà·å´ ·ä†·àç·â∞·à≥·ä´·àù: ' + (message.error || '·ã®·ã≠·àà·çç ·âÉ·àç ·âµ·ä≠·ä≠·àç ·ä†·ã≠·ã∞·àà·àù'), 'error');
                    }
                    break;
                    
                case 'game_state':
                    updateGameStats(message.data);
                    break;
                    
                case 'players_update':
                    updatePlayersList(message.players);
                    break;
                    
                case 'game_message':
                    addGameMessage(message);
                    break;
                    
                case 'error':
                    addSystemMessage('·àµ·àÖ·â∞·âµ: ' + message.message, 'error');
                    break;
                    
                case 'pong':
                    // Keep-alive response
                    break;
            }
        }

        // Show admin panel
        function showAdminPanel() {
            document.getElementById('mainGameUI').style.display = 'none';
            document.getElementById('adminSection').style.display = 'block';
            
            // Hide loading overlay after a short delay
            setTimeout(() => {
                document.getElementById('adminLoading').style.display = 'none';
            }, 1000);
            
            // Request initial game state
            sendAdminCommand('get_game_state');
            sendAdminCommand('get_players');
            
            // Start keep-alive ping
            startKeepAlive();
        }

        // Send admin command
        function sendAdminCommand(command, data = {}) {
            if (adminSocket && adminSocket.readyState === WebSocket.OPEN && isAdminAuthenticated) {
                const message = {
                    type: 'admin_command',
                    command: command,
                    ...data,
                    timestamp: Date.now()
                };
                adminSocket.send(JSON.stringify(message));
            } else {
                addSystemMessage('·ä®·â∞·àò·àã·àã·çä ·ä†·åà·àç·åã·ã≠ ·åã·à≠ ·â∞·åà·äì·äù·â∞·àÖ ·ä†·àà·àÖ?', 'error');
            }
        }

        // Game control functions
        function startGame() {
            sendAdminCommand('start_game');
            addSystemMessage('·å®·ãã·â≥ ·åÄ·àò·à®!');
        }

        function pauseGame() {
            sendAdminCommand('pause_game');
            addSystemMessage('·å®·ãã·â≥ ·âÜ·àò!');
        }

        function endGame() {
            if (confirm('·å®·ãã·â≥·ãç·äï ·àõ·âÜ·àù ·ä•·çà·àç·åã·àà·àÅ?')) {
                sendAdminCommand('end_game');
                addSystemMessage('·å®·ãã·â≥ ·â∞·å†·äì·âã·àç!');
            }
        }

        function resetGame() {
            if (confirm('·å®·ãã·â≥·ãç·äï ·ä•·äï·ã∞·åà·äì ·àà·àò·åÄ·àò·à≠ ·ä•·çà·àç·åã·àà·àÅ?')) {
                sendAdminCommand('reset_game');
                addSystemMessage('·å®·ãã·â≥ ·ä•·äï·ã∞·åà·äì ·â∞·åÄ·àò·à®!');
            }
        }

        function callNextNumber() {
            sendAdminCommand('call_number');
            addSystemMessage('·ä†·ã≤·àµ ·âÅ·å•·à≠ ·â∞·å†·à≠·â∑·àç!');
        }

        function changeGameSpeed(speed) {
            sendAdminCommand('change_speed', { speed: speed });
            addSystemMessage('·ã®·å®·ãã·â≥ ·çç·å•·äê·âµ ·â∞·âÄ·ã≠·àØ·àç: ' + speed);
        }

        function toggleSound() {
            sendAdminCommand('toggle_sound');
            const btn = document.getElementById('soundToggleBtn');
            btn.textContent = btn.textContent.includes('·ä†·â•·à´') ? '·ãµ·àù·åΩ ·ãù·åç' : '·ãµ·àù·åΩ ·ä†·â•·à´';
        }

        function sendAnnouncement() {
            const announcement = prompt('·àõ·àµ·â≥·ãà·âÇ·ã´ ·ä†·àµ·åà·â£:');
            if (announcement) {
                sendAdminCommand('announcement', { text: announcement });
                addSystemMessage('·àõ·àµ·â≥·ãà·âÇ·ã´ ·â∞·àç·ä≥·àç: ' + announcement);
            }
        }

        // Update game statistics
        function updateGameStats(stats) {
            if (stats.totalPlayers !== undefined) {
                document.getElementById('totalPlayers').textContent = stats.totalPlayers;
            }
            if (stats.activePlayers !== undefined) {
                document.getElementById('activePlayers').textContent = stats.activePlayers;
            }
            if (stats.completedGames !== undefined) {
                document.getElementById('completedGames').textContent = stats.completedGames;
            }
            if (stats.gameTime !== undefined) {
                document.getElementById('currentGameTime').textContent = stats.gameTime;
            }
        }

        // Update players list
        function updatePlayersList(players) {
            const container = document.getElementById('playersContainer');
            container.innerHTML = '';
            
            players.forEach(player => {
                const playerItem = document.createElement('div');
                playerItem.className = 'player-item';
                
                playerItem.innerHTML = `
                    <div class="player-info">
                        <div class="player-avatar">${player.name.charAt(0)}</div>
                        <div class="player-name">${player.name}</div>
                    </div>
                    <div class="player-status ${player.online ? 'status-online' : 'status-offline'}">
                        ${player.online ? '·â†·àò·àµ·àò·à≠ ·àã·ã≠' : '·ä®·àò·àµ·àò·à≠ ·ãç·å≠'}
                    </div>
                `;
                
                container.appendChild(playerItem);
            });
        }

        // Add system message
        function addSystemMessage(text, type = 'system') {
            const log = document.getElementById('messageLog');
            const message = document.createElement('div');
            message.className = `message-item ${type}`;
            message.textContent = `[${new Date().toLocaleTimeString()}] ${text}`;
            
            log.appendChild(message);
            log.scrollTop = log.scrollHeight;
        }

        // Add game message
        function addGameMessage(message) {
            const log = document.getElementById('messageLog');
            const messageElement = document.createElement('div');
            messageElement.className = 'message-item';
            messageElement.textContent = `[${new Date().toLocaleTimeString()}] ${message.text}`;
            
            log.appendChild(messageElement);
            log.scrollTop = log.scrollHeight;
        }

        // Send admin message
        function sendAdminMessage() {
            const input = document.getElementById('adminMessage');
            const message = input.value.trim();
            
            if (message) {
                sendAdminCommand('broadcast_message', { text: message });
                addSystemMessage('·àò·àç·ãï·ä≠·âµ·àÖ ·â∞·àç·ä≥·àç: ' + message);
                input.value = '';
            }
        }

        function handleAdminMessageKey(event) {
            if (event.key === 'Enter') {
                sendAdminMessage();
            }
        }

        // Close admin panel
        function closeAdminPanel() {
            if (adminSocket) {
                adminSocket.close();
            }
            document.getElementById('adminSection').style.display = 'none';
            document.getElementById('mainGameUI').style.display = 'block';
            document.getElementById('adminLoading').style.display = 'flex';
            isAdminAuthenticated = false;
            
            if (keepAliveInterval) {
                clearInterval(keepAliveInterval);
                keepAliveInterval = null;
            }
        }

        // Export game data
        function exportGameData() {
            sendAdminCommand('export_data');
            addSystemMessage('·ã®·å®·ãã·â≥ ·àò·à®·åÉ ·àà·àò·àã·ä≠ ·â≥·ãû ·äê·ãç...');
        }

        // Connection status handling
        function showConnectionStatus(status, message) {
            const element = document.getElementById('connectionStatus');
            element.textContent = message;
            element.className = `connection-status status-${status}`;
            element.style.display = 'block';
            
            if (status === 'connected') {
                setTimeout(() => {
                    element.style.display = 'none';
                }, 3000);
            }
        }

        function handleConnectionError(errorMessage) {
            showConnectionStatus('error', errorMessage);
            
            if (connectionAttempts < MAX_RETRIES) {
                addSystemMessage(`·ä•·äï·ã∞·åà·äì ·â†·àò·åà·äì·äò·âµ ·àã·ã≠... (${connectionAttempts}/${MAX_RETRIES})`, 'error');
                reconnectTimeout = setTimeout(() => {
                    connectAdminWebSocket();
                }, 2000 * connectionAttempts); // Exponential backoff
            } else {
                addSystemMessage('·ä®·çç·â∞·äõ ·ã®·àò·åà·äì·äò·âµ ·àô·ä®·à´·ãé·âΩ. ·ä•·â£·ä≠·àÖ ·åà·åπ·äï ·ä†·ãµ·àµ.', 'error');
            }
        }

        function handleConnectionClose(event) {
            isAdminAuthenticated = false;
            
            if (event.code !== 1000) { // Abnormal closure
                showConnectionStatus('disconnected', '·ä®·â∞·àò·àã·àã·çä ·ä†·åà·àç·åã·ã≠ ·â∞·âã·à≠·åß·àç');
                
                if (connectionAttempts < MAX_RETRIES) {
                    reconnectTimeout = setTimeout(() => {
                        connectAdminWebSocket();
                    }, 3000);
                }
            }
        }

        // Keep-alive mechanism
        let keepAliveInterval = null;
        function startKeepAlive() {
            if (keepAliveInterval) {
                clearInterval(keepAliveInterval);
            }
            
            keepAliveInterval = setInterval(() => {
                if (adminSocket && adminSocket.readyState === WebSocket.OPEN && isAdminAuthenticated) {
                    adminSocket.send(JSON.stringify({ type: 'ping', timestamp: Date.now() }));
                }
            }, 30000); // Send ping every 30 seconds
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Add keyboard shortcut for admin panel (Ctrl+Shift+A)
            document.addEventListener('keydown', function(event) {
                if (event.ctrlKey && event.shiftKey && event.key === 'A') {
                    event.preventDefault();
                    showAdminModal();
                }
            });
            
            // Auto-focus password input when modal is shown
            document.getElementById('adminPasswordModal').addEventListener('click', function(event) {
                if (event.target === this) {
                    hideAdminModal();
                }
            });
        });

        // Error boundary for unhandled errors
        window.addEventListener('error', function(event) {
            console.error('Unhandled error:', event.error);
            addSystemMessage('·ã´·àç·â∞·å†·â†·âÄ ·àµ·àÖ·â∞·âµ ·â∞·ä®·àµ·â∑·àç. ·ä•·â£·ä≠·àÖ ·ä•·äï·ã∞·åà·äì ·àû·ä≠·à≠.', 'error');
        });
    </script>
</body>
</html>
